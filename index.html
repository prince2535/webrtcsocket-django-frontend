<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Stravo</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<style>
body {
  background: radial-gradient(circle at top, #1a1a1a, #000);
  color: white;
  font-family: 'Inter', Arial, sans-serif;
  margin: 0;
}

.glass {
  background: rgba(255,255,255,0.06);
  backdrop-filter: blur(18px);
  border-radius: 22px;
  padding: 24px;
  box-shadow: 0 30px 80px rgba(0,0,0,0.8);
  max-width: 1150px;
  margin: 25px auto;
}

h2 { margin-bottom: 4px; }

.subtitle {
  opacity: 0.6;
  font-size: 14px;
  margin-bottom: 10px;
}

.badges {
  display: flex;
  justify-content: center;
  gap: 12px;
  margin-bottom: 10px;
}

.badge {
  padding: 6px 12px;
  border-radius: 999px;
  font-size: 12px;
  font-weight: 600;
  background: rgba(255,255,255,0.12);
}

.badge.good { color:#00ffcc; }
.badge.warn { color:#ffcc00; }

.videos {
  display: flex;
  gap: 16px;
  margin-top: 16px;
}

video {
  width: 50%;
  height: 330px;
  background: black;
  border-radius: 16px;
  box-shadow: 0 15px 40px rgba(0,0,0,0.7);
}

#localVideo { transform: scaleX(-1); }
.blur { filter: blur(14px); }

input {
  padding: 10px;
  margin: 6px;
  width: 220px;
  border-radius: 10px;
  border: none;
}

button {
  padding: 10px 20px;
  margin: 6px;
  border-radius: 999px;
  border: none;
  font-weight: 700;
  cursor: pointer;
  background: linear-gradient(135deg,#00ffcc,#00b3ff);
  color:#000;
}

button:disabled {
  opacity: 0.4;
  cursor: not-allowed;
}

#chatBox {
  background: rgba(0,0,0,0.45);
  border-radius: 12px;
  padding: 10px;
  height: 130px;
  overflow-y: auto;
  margin-top: 8px;
  text-align: left;
}

#typing {
  font-size: 12px;
  opacity: 0.6;
  height: 16px;
}

@media (max-width: 768px) {
  .videos { flex-direction: column; }
  video { width: 100%; height: 260px; }
}
</style>
</head>

<body>

<div class="glass">

<h2>Stravo</h2>
<p class="subtitle">Instant 1-to-1 video chat</p>

<div class="badges">
  <span id="userBadge" class="badge">You</span>
  <span id="partnerBadge" class="badge">Waiting…</span>
  <span id="qualityBadge" class="badge warn">Quality: —</span>
  <span id="timerBadge" class="badge">00:00</span>
</div>

<div id="authBox">
  <input id="email" placeholder="Email">
  <input id="password" type="password" placeholder="Password">
  <button onclick="login()">Login</button>
</div>

<div class="videos">
  <video id="localVideo" class="blur" autoplay muted playsinline></video>
  <video id="remoteVideo" autoplay playsinline></video>
</div>

<button id="startBtn" onclick="start()" disabled>Start</button>
<button id="nextBtn" onclick="next()" disabled>Next</button>

<div>
  <input id="chatInput" placeholder="Type message" oninput="sendTyping()">
  <button onclick="sendMessage()">Send</button>
  <div id="typing"></div>
  <div id="chatBox"></div>
</div>

</div>

<script>
/* ================= STATE ================= */
const localVideo = document.getElementById("localVideo");
const remoteVideo = document.getElementById("remoteVideo");
const chatBox = document.getElementById("chatBox");
const typingDiv = document.getElementById("typing");
const chatInput = document.getElementById("chatInput");
const startBtn = document.getElementById("startBtn");
const nextBtn = document.getElementById("nextBtn");
const authBox = document.getElementById("authBox");
const partnerBadge = document.getElementById("partnerBadge");
const qualityBadge = document.getElementById("qualityBadge");
const timerBadge = document.getElementById("timerBadge");

let ws, wsReady=false;
let pc=null, room=null, isInitiator=false;
let localStream=null;
let typingTimer=null;
let timerInt=null, seconds=0;

/* ================= LOGIN (JWT UI GATE) ================= */
function login(){
  localStorage.setItem("jwt","demo-token");
  authBox.style.display="none";
  startBtn.disabled=false;
  nextBtn.disabled=false;
}

/* ================= MEDIA ================= */
navigator.mediaDevices.getUserMedia({video:true,audio:true})
.then(s=>{
  localStream=s;
  localVideo.srcObject=s;
});

/* ================= WEBSOCKET ================= */
ws=new WebSocket("wss://webrtcsocket-django-backend.onrender.com/ws/chat/");
ws.onopen=()=>wsReady=true;
ws.onmessage=handleMessage;

/* ================= CONTROL ================= */
function cleanup(){
  if(pc) pc.close();
  pc=null;
  remoteVideo.srcObject=null;
  clearInterval(timerInt);
  seconds=0;
  timerBadge.innerText="00:00";
}

function start(){
  if(!wsReady) return;
  ws.send(JSON.stringify({type:"start"}));
}

function next(){
  cleanup();
  ws.send(JSON.stringify({type:"next"}));
}

/* ================= CHAT ================= */
function addMessage(w,t){
  const p=document.createElement("p");
  p.innerText=w+": "+t;
  chatBox.appendChild(p);
}

function sendMessage(){
  if(!room||!chatInput.value) return;
  ws.send(JSON.stringify({room,type:"chat",text:chatInput.value}));
  addMessage("Me",chatInput.value);
  chatInput.value="";
}

function sendTyping(){
  if(!room) return;
  ws.send(JSON.stringify({room,type:"typing"}));
}

/* ================= SIGNALING (UNTOUCHED) ================= */
async function handleMessage(e){
  const d=JSON.parse(e.data);

  if(d.type==="matched"){
    cleanup();
    room=d.room;
    isInitiator=d.initiator;
    localVideo.classList.remove("blur");
    partnerBadge.innerText="Connected";
    startTimer();

    pc=new RTCPeerConnection({
      iceServers:[{urls:"stun:stun.l.google.com:19302"}]
    });

    localStream.getTracks().forEach(t=>pc.addTrack(t,localStream));

    pc.ontrack=e=>{
      remoteVideo.srcObject=e.streams[0];
      remoteVideo.play().catch(()=>{});
    };

    pc.onicecandidate=e=>{
      if(e.candidate) ws.send(JSON.stringify({room,candidate:e.candidate}));
    };

    if(isInitiator){
      const offer=await pc.createOffer();
      await pc.setLocalDescription(offer);
      ws.send(JSON.stringify({room,sdp:offer}));
    }

    monitorQuality();
  }

  if(d.sdp&&pc){
    await pc.setRemoteDescription(new RTCSessionDescription(d.sdp));
    if(d.sdp.type==="offer"){
      const ans=await pc.createAnswer();
      await pc.setLocalDescription(ans);
      ws.send(JSON.stringify({room,sdp:ans}));
    }
  }

  if(d.candidate&&pc){
    try{await pc.addIceCandidate(new RTCIceCandidate(d.candidate));}catch{}
  }

  if(d.type==="chat") addMessage("Partner",d.text);

  if(d.type==="typing"){
    typingDiv.innerText="Partner typing…";
    clearTimeout(typingTimer);
    typingTimer=setTimeout(()=>typingDiv.innerText="",1500);
  }
}

/* ================= EXTRAS ================= */
function startTimer(){
  timerInt=setInterval(()=>{
    seconds++;
    const m=String(Math.floor(seconds/60)).padStart(2,"0");
    const s=String(seconds%60).padStart(2,"0");
    timerBadge.innerText=`${m}:${s}`;
  },1000);
}

function monitorQuality(){
  setInterval(async()=>{
    if(!pc) return;
    const stats=await pc.getStats();
    stats.forEach(r=>{
      if(r.type==="candidate-pair"&&r.state==="succeeded"){
        qualityBadge.innerText="Quality: Good";
        qualityBadge.className="badge good";
      }
    });
  },3000);
}
</script>

</body>
</html>
