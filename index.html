<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Django WebRTC Chat</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<style>
body {
  background:#0f0f0f;
  color:white;
  font-family:'Inter', Arial, sans-serif;
  margin:0;
}

.glass {
  background: rgba(255,255,255,0.05);
  backdrop-filter: blur(14px);
  border-radius: 20px;
  padding: 20px;
  box-shadow: 0 0 40px rgba(0,0,0,0.7);
  max-width: 1200px;
  margin: 20px auto;
}

h2 { margin:5px 0; }

#statusText {
  color:#00ffcc;
  font-weight:600;
  margin-bottom:10px;
}

/* ===== VIDEO ===== */
.videos {
  display:flex;
  gap:16px;
  margin-top:15px;
}

.video-wrap {
  position:relative;
  width:50%;
}

video {
  width:100%;
  height:320px;
  background:black;
  border-radius:16px;
}

.blur {
  filter: blur(14px);
}

#localVideo { transform: scaleX(-1); }

/* ===== CONTROLS ===== */
.controls {
  display:flex;
  justify-content:center;
  gap:12px;
  margin:12px 0;
}

.control-btn {
  background: rgba(255,255,255,0.1);
  border:none;
  border-radius:50%;
  width:48px;
  height:48px;
  cursor:pointer;
  color:#00ffcc;
  font-size:18px;
}

.control-btn:hover {
  background: rgba(0,255,204,0.2);
}

/* ===== CHAT ===== */
.chat {
  background:#0b0b0b;
  border-radius:14px;
  margin-top:15px;
  padding:10px;
  height:200px;
  display:flex;
  flex-direction:column;
}

#chatBox {
  flex:1;
  overflow:auto;
  font-size:14px;
}

.msg {
  margin:6px 0;
  max-width:70%;
  padding:8px 12px;
  border-radius:12px;
}

.me {
  background:#00ffcc;
  color:black;
  align-self:flex-end;
}

.partner {
  background:#222;
  color:white;
  align-self:flex-start;
}

.chat-input {
  display:flex;
  gap:8px;
  margin-top:6px;
}

.chat-input input {
  flex:1;
  padding:10px;
  border-radius:20px;
  border:none;
}

.chat-input button {
  padding:10px 16px;
  border-radius:20px;
  border:none;
  background:#00ffcc;
  font-weight:700;
  cursor:pointer;
}

#typing {
  font-size:12px;
  color:#aaa;
  height:16px;
}

/* ===== AUTH ===== */
#authBox input {
  padding:10px;
  width:220px;
  border-radius:8px;
  border:none;
  margin:5px 0;
}

#authBox button {
  padding:10px 18px;
  border-radius:20px;
  border:none;
  background:#00ffcc;
  font-weight:700;
  cursor:pointer;
}

/* ===== MOBILE ===== */
@media(max-width:768px){
  .videos { flex-direction:column; }
  .video-wrap { width:100%; }
  video { height:260px; }
}
</style>
</head>

<body>

<div class="glass">
  <h2>Django WebRTC Video Chat</h2>
  <div id="statusText">Ready</div>

  <!-- AUTH -->
  <div id="authBox">
    <input id="email" placeholder="Email"><br>
    <input id="password" type="password" placeholder="Password"><br>
    <button onclick="login()">Login</button>
  </div>

  <!-- VIDEO -->
  <div class="videos">
    <div class="video-wrap">
      <video id="localVideo" class="blur" autoplay muted playsinline></video>
    </div>
    <div class="video-wrap">
      <video id="remoteVideo" autoplay playsinline></video>
    </div>
  </div>

  <!-- CONTROLS -->
  <div class="controls">
    <button class="control-btn" onclick="toggleMic()">üé§</button>
    <button class="control-btn" onclick="toggleCam()">üì∑</button>
    <button class="control-btn" onclick="switchCamera()">üîÑ</button>
    <button class="control-btn" onclick="start()">‚ñ∂</button>
    <button class="control-btn" onclick="next()">‚è≠</button>
  </div>

  <!-- CHAT -->
  <div class="chat">
    <div id="chatBox"></div>
    <div id="typing"></div>
    <div class="chat-input">
      <input id="chatInput" placeholder="Type message‚Ä¶" oninput="sendTyping()">
      <button onclick="sendMessage()">Send</button>
    </div>
  </div>
</div>

<script>
let ws, pc, room, isInitiator;
let localStream = null;
let currentFacing = "user";
let typingTimer = null;

const localVideo = document.getElementById("localVideo");
const remoteVideo = document.getElementById("remoteVideo");
const chatBox = document.getElementById("chatBox");
const chatInput = document.getElementById("chatInput");
const typingDiv = document.getElementById("typing");
const statusText = document.getElementById("statusText");
const authBox = document.getElementById("authBox");

/* ===== LOGIN (mock) ===== */
function login(){
  authBox.style.display="none";
  statusText.innerText="Logged in";
}

/* ===== MEDIA ===== */
async function initMedia(){
  localStream = await navigator.mediaDevices.getUserMedia({
    video:{ facingMode: currentFacing },
    audio:true
  });
  localVideo.srcObject = localStream;
}
initMedia();

/* ===== WS ===== */
ws = new WebSocket("wss://webrtcsocket-django-backend.onrender.com/ws/chat/");
ws.onmessage = handleMessage;

/* ===== CONTROLS ===== */
function toggleMic(){
  localStream.getAudioTracks().forEach(t=>t.enabled=!t.enabled);
}
function toggleCam(){
  localStream.getVideoTracks().forEach(t=>t.enabled=!t.enabled);
}
async function switchCamera(){
  currentFacing = currentFacing==="user" ? "environment" : "user";
  if(localStream) localStream.getTracks().forEach(t=>t.stop());
  await initMedia();
}

/* ===== START / NEXT ===== */
function start(){
  ws.send(JSON.stringify({type:"start"}));
}
function next(){
  cleanup();
  ws.send(JSON.stringify({type:"next"}));
}

/* ===== CLEANUP ===== */
function cleanup(){
  if(pc) pc.close();
  pc=null;
  remoteVideo.srcObject=null;
}

/* ===== CHAT ===== */
function addMsg(w,t){
  const d=document.createElement("div");
  d.className="msg "+(w==="Me"?"me":"partner");
  d.innerText=t;
  chatBox.appendChild(d);
  chatBox.scrollTop=chatBox.scrollHeight;
}
function sendMessage(){
  if(!room||!chatInput.value) return;
  ws.send(JSON.stringify({room,type:"chat",text:chatInput.value}));
  addMsg("Me",chatInput.value);
  chatInput.value="";
}
function sendTyping(){
  if(!room) return;
  ws.send(JSON.stringify({room,type:"typing"}));
}

/* ===== SIGNALING ===== */
async function handleMessage(e){
  const d=JSON.parse(e.data);

  if(d.type==="matched"){
    cleanup();
    room=d.room;
    isInitiator=d.initiator;
    localVideo.classList.remove("blur");
    statusText.innerText="Connected";

    pc=new RTCPeerConnection({
      iceServers:[{urls:"stun:stun.l.google.com:19302"}]
    });

    localStream.getTracks().forEach(t=>pc.addTrack(t,localStream));

    pc.ontrack=e=>{
      remoteVideo.srcObject=e.streams[0];
      remoteVideo.play().catch(()=>{});
    };

    pc.onicecandidate=e=>{
      if(e.candidate) ws.send(JSON.stringify({room,candidate:e.candidate}));
    };

    if(isInitiator){
      const offer=await pc.createOffer();
      await pc.setLocalDescription(offer);
      ws.send(JSON.stringify({room,sdp:offer}));
    }
  }

  if(d.sdp && pc){
    await pc.setRemoteDescription(new RTCSessionDescription(d.sdp));
    if(d.sdp.type==="offer"){
      const ans=await pc.createAnswer();
      await pc.setLocalDescription(ans);
      ws.send(JSON.stringify({room,sdp:ans}));
    }
  }

  if(d.candidate && pc){
    try{await pc.addIceCandidate(d.candidate);}catch{}
  }

  if(d.type==="chat") addMsg("Partner",d.text);

  if(d.type==="typing"){
    typingDiv.innerText="Partner typing‚Ä¶";
    clearTimeout(typingTimer);
    typingTimer=setTimeout(()=>typingDiv.innerText="",1200);
  }
}
</script>

</body>
</html>
