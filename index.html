<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Django WebRTC Chat</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<style>
body {
  background:#0f0f0f;
  color:white;
  text-align:center;
  font-family:'Inter', Arial, sans-serif;
}
.glass {
  background: rgba(255,255,255,0.05);
  backdrop-filter: blur(14px);
  border-radius: 18px;
  padding: 20px;
  box-shadow: 0 0 40px rgba(0,0,0,0.7);
  max-width: 1100px;
  margin: 20px auto;
}
#statusText { color:#00ffcc; font-weight:600; }
.videos { display:flex; justify-content:center; gap:14px; margin-top:15px; }
video { width:45%; height:320px; background:black; border-radius:14px; }
.blur { filter: blur(14px); }
#localVideo { transform: scaleX(-1); }
input { padding:10px; margin:6px; width:220px; border-radius:8px; border:none; }
button {
  padding:10px 18px;
  margin:6px;
  cursor:pointer;
  border-radius:30px;
  border:none;
  font-weight:700;
  background: linear-gradient(135deg, #00ffcc, #00b3ff);
  color:#000;
}
button:disabled { opacity:0.4; cursor:not-allowed; }
#chatBox {
  background: rgba(0,0,0,0.4);
  border-radius:10px;
  margin-top:8px;
  padding:8px;
  height:120px;
  overflow:auto;
  text-align:left;
}
#typing { font-size:12px; color:#aaa; height:16px; }
@media (max-width:768px){
  .videos{flex-direction:column;}
  video{width:100%;height:260px;}
}
</style>
</head>

<body>
<div class="glass">

<h2>Django WebRTC Video Chat</h2>
<p id="statusText">Ready</p>

<div id="authBox">
  <input id="email" placeholder="Email"><br>
  <input id="password" type="password" placeholder="Password"><br>
  <button onclick="login()">Login</button>
</div>

<div class="videos">
  <video id="localVideo" class="blur" autoplay muted playsinline></video>
  <video id="remoteVideo" autoplay playsinline></video>
</div>

<button id="startBtn" onclick="start()" disabled>Start</button>
<button id="nextBtn" onclick="next()" disabled>Next</button>

<div>
  <input id="chatInput" placeholder="Type message" oninput="sendTyping()">
  <button onclick="sendMessage()">Send</button>
  <div id="typing"></div>
  <div id="chatBox"></div>
</div>

</div>

<script>
/* ===== STATE ===== */
const statusText = document.getElementById("statusText");
const localVideo = document.getElementById("localVideo");
const remoteVideo = document.getElementById("remoteVideo");
const chatBox = document.getElementById("chatBox");
const typingDiv = document.getElementById("typing");
const chatInput = document.getElementById("chatInput");
const startBtn = document.getElementById("startBtn");
const nextBtn = document.getElementById("nextBtn");
const authBox = document.getElementById("authBox");

let ws, wsReady = false;
let pc = null, room = null, isInitiator = false;
let localStream = null;
let typingTimer = null;
let autoNextTimer = null;

function setStatus(t){ statusText.innerText = t; }

/* ===== LOGIN (mock) ===== */
function login(){
  authBox.style.display="none";
  startBtn.disabled=false;
  nextBtn.disabled=false;
  setStatus("Logged in");
}

/* ===== MEDIA ===== */
navigator.mediaDevices.getUserMedia({ video:true, audio:true })
.then(stream=>{
  localStream = stream;
  localVideo.srcObject = stream;
  console.log("Audio tracks:", localStream.getAudioTracks());
})
.catch(err=>{
  alert("Camera/Mic permission denied");
  console.error(err);
});

/* ===== WEBSOCKET ===== */
function connectWS(){
  ws = new WebSocket("wss://webrtcsocket-django-backend.onrender.com/ws/chat/");

  ws.onopen = () => {
    wsReady = true;
    setStatus("Connected to server");
  };

  ws.onclose = () => {
    wsReady = false;
    setStatus("Server disconnected");
  };

  ws.onerror = e => console.error("WebSocket error", e);

  ws.onmessage = handleMessage;
}
connectWS();

/* ===== CONTROL ===== */
function cleanup(){
  if(pc) pc.close();
  pc = null;
  remoteVideo.srcObject = null;
  clearTimeout(autoNextTimer);
}

function start(){
  if(!wsReady) return setStatus("WebSocket not ready");
  setStatus("Searching...");
  ws.send(JSON.stringify({ type:"start" }));
}

function next(){
  if(!wsReady) return setStatus("WebSocket not ready");
  cleanup();
  setStatus("Searching...");
  ws.send(JSON.stringify({ type:"next" }));
}

/* ===== CHAT ===== */
function addMessage(who,text){
  const p=document.createElement("p");
  p.innerText=who+": "+text;
  chatBox.appendChild(p);
}

function sendMessage(){
  if(!room || !chatInput.value) return;
  ws.send(JSON.stringify({ room, type:"chat", text:chatInput.value }));
  addMessage("Me", chatInput.value);
  chatInput.value="";
}

function sendTyping(){
  if(!room) return;
  ws.send(JSON.stringify({ room, type:"typing" }));
}

/* ===== SIGNALING ===== */
async function handleMessage(e){
  const d = JSON.parse(e.data);

  if(d.type === "matched"){
    cleanup();
    room = d.room;
    isInitiator = d.initiator;
    localVideo.classList.remove("blur");
    setStatus("Connected");

    autoNextTimer = setTimeout(next, 60000);

    pc = new RTCPeerConnection({
      iceServers:[{ urls:"stun:stun.l.google.com:19302" }]
    });

    localStream.getTracks().forEach(t => pc.addTrack(t, localStream));

    /* ðŸ”‘ CRITICAL FIX: VIDEO + AUDIO */
    pc.ontrack = e => {
      console.log("Remote stream received");
      remoteVideo.srcObject = e.streams[0];
      remoteVideo.muted = false;
      remoteVideo.volume = 1.0;
      remoteVideo.playsInline = true;

      const p = remoteVideo.play();
      if (p !== undefined) {
        p.catch(err => console.warn("Autoplay blocked:", err));
      }
    };

    pc.onicecandidate = e => {
      if(e.candidate){
        ws.send(JSON.stringify({ room, candidate:e.candidate }));
      }
    };

    if(isInitiator){
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      ws.send(JSON.stringify({ room, sdp:offer }));
    }
  }

  if(d.sdp && pc){
    await pc.setRemoteDescription(new RTCSessionDescription(d.sdp));
    if(d.sdp.type === "offer"){
      const ans = await pc.createAnswer();
      await pc.setLocalDescription(ans);
      ws.send(JSON.stringify({ room, sdp:ans }));
    }
  }

  if(d.candidate && pc){
    try{ await pc.addIceCandidate(new RTCIceCandidate(d.candidate)); }catch{}
  }

  if(d.type === "chat") addMessage("Partner", d.text);

  if(d.type === "typing"){
    typingDiv.innerText="Partner typing...";
    clearTimeout(typingTimer);
    typingTimer=setTimeout(()=>typingDiv.innerText="",1500);
  }
}
</script>
</body>
</html>
